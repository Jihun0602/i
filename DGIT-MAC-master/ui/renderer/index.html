<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGit MAC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #007aff;
            --accent-green: #34c759;
            --accent-red: #ff3b30;
            --accent-orange: #ff9500;
            --border-color: #404040;
            --hover-bg: #404040;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --text-primary: #000000;
            --text-secondary: #666666;
            --border-color: #d0d0d0;
            --hover-bg: #e5e5e5;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* 로딩 화면 */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .splash-logo {
            font-size: 5rem;
            font-weight: 300;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .splash-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-blue);
            animation: loadingPulse 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loadingPulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* 메인 앱 컨테이너 */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .app-container.visible {
            opacity: 1;
        }

        /* 타이틀바 */
        .title-bar {
            height: 28px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            -webkit-app-region: drag;
            position: relative;
            padding: 0;
            z-index: 1000;
        }


        .title-text {
            flex: 1;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .theme-toggle {
            -webkit-app-region: no-drag;
            background: none;
            border: none;
            color: var(--text-secondary);
            flex-shrink: 0;
            cursor: pointer;
            padding: 4px 16px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
        }

        /* 메인 화면 */
        .home-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .home-logo {
            font-size: 5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .home-logo-icon {
            width: 80px;
            height: 80px;
            background-image: url('assets/icon.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .home-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 3rem;
        }

        .home-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 400px;
        }

        .home-button {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--text-primary);
        }

        .home-button:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
        }

        .home-button-icon {
            font-size: 1.2rem;
        }

        .home-button-text {
            flex: 1;
        }

        .home-button-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .home-button-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* 프로젝트 작업 화면 */
        .workspace {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .workspace.active {
            display: flex;
        }

        .workspace-header {
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 16px;
        }

        .project-info h2 {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .project-path {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .workspace-content {
            flex: 1;
            display: flex;
        }

        .sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: var(--hover-bg);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .terminal-panel {
            height: 200px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            height: 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
        }

        .terminal-tabs {
            display: flex;
            gap: 16px;
        }

        .terminal-tab {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .terminal-tab.active {
            background: var(--hover-bg);
        }

        .terminal-content {
            flex: 1;
            padding: 12px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            overflow-y: auto;
        }

        /* 파일 리스트 */
        .file-list {
            display: grid;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background: var(--hover-bg);
        }

        .file-thumbnail {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .file-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .file-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
        }

        /* 커밋 히스토리 */
        .commit-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .commit-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .commit-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }

        .commit-details {
            flex: 1;
        }

        .commit-message {
            font-weight: 500;
            margin-bottom: 6px;
        }

        .commit-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            gap: 16px;
        }

        .commit-thumbnail {
            width: 60px;
            height: 40px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* 모달 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: var(--text-secondary);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #0056cc;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        /* 토스트 알림 */
        .toast-container {
            position: fixed;
            top: 40px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            animation: toastSlideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .toast.success { border-left: 4px solid var(--accent-green); }
        .toast.error { border-left: 4px solid var(--accent-red); }
        .toast.warning { border-left: 4px solid var(--accent-orange); }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 브랜치 시각화 */
        .branch-graph {
            height: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .branch-node {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 2px solid var(--bg-primary);
        }

        .branch-line {
            position: absolute;
            height: 2px;
            background: var(--accent-blue);
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .workspace-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .terminal-panel {
                height: 150px;
            }
        }

        /* 숨김 클래스 */
        .hidden {
            display: none;
        }
    </style>
</head>
<body data-theme="dark">
    <!-- 로딩 화면 -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">DGit</div>
        <div class="splash-loading">
            <span>로딩 중</span>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <!-- 메인 앱 -->
    <div class="app-container" id="appContainer">
        <!-- 타이틀바 -->
        <div class="title-bar">
            <div class="title-text" id="titleText">DGit MAC</div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">🌙</span>
            </button>
        </div>

        <!-- 홈 화면 -->
        <div class="home-screen" id="homeScreen">
            <div class="home-logo">
                <div class="home-logo-icon"></div>
                DGit
            </div>
            <div class="home-subtitle">디자인 파일 전용 버전 관리 시스템</div>
            <div class="home-buttons">
                <div class="home-button" onclick="selectNewProject()">
                    <div class="home-button-icon">✅</div>
                    <div class="home-button-text">
                        <div class="home-button-title">새 프로젝트 선택</div>
                        <div class="home-button-desc">새로운 디자인 프로젝트를 시작합니다</div>
                    </div>
                </div>
                <div class="home-button" onclick="openCurrentProject()">
                    <div class="home-button-icon">📂</div>
                    <div class="home-button-text">
                        <div class="home-button-title">진행 중인 프로젝트</div>
                        <div class="home-button-desc">가장 최근 프로젝트를 바로 엽니다</div>
                    </div>
                </div>
                <div class="home-button" onclick="showRecentProjects()">
                    <div class="home-button-icon">🕘</div>
                    <div class="home-button-text">
                        <div class="home-button-title">지난 프로젝트</div>
                        <div class="home-button-desc">최근 작업한 프로젝트 목록에서 선택</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 작업 공간 -->
        <div class="workspace" id="workspace">
            <!-- 헤더 -->
            <div class="workspace-header">
                <button class="btn btn-secondary" onclick="goHome()">← 홈</button>
                <div class="project-info">
                    <h2 id="projectName">프로젝트명</h2>
                    <div class="project-path" id="projectPath">/path/to/project</div>
                </div>
            </div>

            <!-- 콘텐츠 영역 -->
            <div class="workspace-content">
                <!-- 사이드바 -->
                <div class="sidebar">
                    <ul class="sidebar-nav">
                        <li class="sidebar-item active" onclick="showContent('files')">
                            <span>📁</span> 파일
                        </li>
                        <li class="sidebar-item" onclick="showContent('versions')">
                            <span>📝</span> 버전
                        </li>
                        <li class="sidebar-item" onclick="showContent('branches')">
                            <span>🌿</span> 브랜치
                        </li>
                        <li class="sidebar-item" onclick="showContent('notifications')">
                            <span>🔔</span> 알림
                        </li>
                        <li class="sidebar-item" onclick="showContent('settings')">
                            <span>⚙️</span> 설정
                        </li>
                    </ul>
                </div>

                <!-- 메인 콘텐츠 -->
                <div class="main-content">
                    <div class="content-area">
                        <!-- 파일 목록 -->
                        <div id="filesContent" class="content-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>프로젝트 파일</h3>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="changeProject()">프로젝트 변경</button>
                                    <button class="btn btn-secondary" onclick="scanProject()">스캔</button>
                                    <button class="btn btn-secondary" onclick="addAllFiles()">모든 파일 추가</button>
                                    <button class="btn btn-secondary" onclick="restoreFiles()">복원</button>
                                    <button class="btn btn-secondary" onclick="showInFinder()">Finder에서 보기</button>
                                    <button class="btn btn-primary" onclick="commitChanges()">변경사항 커밋</button>
                                </div>
                            </div>
                            <div class="file-list" id="fileList">
                                <!-- 파일 항목들이 여기에 동적으로 추가됩니다 -->
                            </div>
                        </div>

                        <!-- 버전 히스토리 -->
                        <div id="versionsContent" class="content-section hidden">
                            <h3 style="margin-bottom: 20px;">커밋 히스토리</h3>
                            <div class="commit-list" id="commitList">
                                <!-- 커밋 항목들이 여기에 동적으로 추가됩니다 -->
                            </div>
                        </div>

                        <!-- 브랜치 관리 -->
                        <div id="branchesContent" class="content-section hidden">
                            <h3 style="margin-bottom: 20px;">브랜치 관리</h3>
                            <div class="branch-graph" id="branchGraph"></div>
                            <button class="btn btn-primary" onclick="createBranch()">새 브랜치 생성</button>
                        </div>

                        <!-- 알림 -->
                        <div id="notificationsContent" class="content-section hidden">
                            <h3 style="margin-bottom: 20px;">알림 설정</h3>
                            <p>알림 관련 설정들이 여기에 표시됩니다.</p>
                        </div>

                        <!-- 설정 -->
                        <div id="settingsContent" class="content-section hidden">
                            <h3 style="margin-bottom: 20px;">환경설정</h3>
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px;">정보</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 8px;">버전: 1.0.0</p>
                                <p style="color: var(--text-secondary); margin-bottom: 8px;">제작: 3pxTeam</p>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 10px;">테마</h4>
                                <button class="btn btn-secondary" onclick="toggleTheme()">
                                    <span id="themeText">라이트 모드로 전환</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 터미널 패널 -->
                    <div class="terminal-panel">
                        <div class="terminal-header">
                            <div class="terminal-tabs">
                                <div class="terminal-tab active" onclick="showTerminalTab('log')">커밋 로그</div>
                                <div class="terminal-tab" onclick="showTerminalTab('status')">상태</div>
                            </div>
                        </div>
                        <div class="terminal-content" id="terminalContent">
                            <div id="terminalLog">커밋 로그가 여기에 표시됩니다...</div>
                            <div id="terminalStatus" class="hidden">상태 정보가 여기에 표시됩니다...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달들 -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">모달 제목</div>
                <div class="modal-subtitle" id="modalSubtitle">모달 부제목</div>
            </div>
            <div class="modal-body" id="modalBody">
                모달 내용
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                <button class="btn btn-primary" onclick="confirmModal()">확인</button>
            </div>
        </div>
    </div>

    <!-- 토스트 컨테이너 -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // 전역 변수
        let currentProject = null;
        let currentTheme = 'dark';
        let activeContent = 'files';

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 로딩 화면 표시 후 메인 앱으로 전환
            setTimeout(() => {
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('appContainer').classList.add('visible');
                initializeApp();
            }, 2000);
        });

        // 프로젝트 데이터 로드
        async function loadProjectData() {
            if (!currentProject) return;
            
            try {
                // 프로젝트 파일 스캔
                await loadProjectFiles();
                
                // 커밋 히스토리 로드
                await loadCommitHistory();
                
                // DGit 상태 확인
                await updateProjectStatus();
                
            } catch (error) {
                console.error('프로젝트 데이터 로드 실패:', error);
                showToast('프로젝트 데이터를 로드하는 중 오류가 발생했습니다', 'error');
            }
        }

        // 프로젝트 파일 로드
        async function loadProjectFiles() {
            if (!currentProject) return;
            
            try {
                const result = await window.electron.scanDirectory(currentProject.path);
                
                if (result.success) {
                    const files = result.files.map(file => ({
                        name: file.name,
                        type: file.type,
                        size: formatFileSize(file.size),
                        modified: formatDate(file.modified),
                        status: 'unknown', // 상태는 별도로 확인
                        path: file.path
                    }));
                    
                    // DGit 상태로 파일 상태 업데이트
                    await updateFileStatuses(files);
                    renderFiles(files);
                } else {
                    showToast('파일을 스캔할 수 없습니다', 'error');
                }
            } catch (error) {
                console.error('파일 로드 실패:', error);
                showToast('파일 로드 중 오류가 발생했습니다', 'error');
            }
        }

        // 커밋 히스토리 로드
        async function loadCommitHistory() {
            if (!currentProject) return;
            
            try {
                const result = await window.electron.dgit.log(currentProject.path, 10);
                
                if (result.success) {
                    const commits = parseCommitLog(result.output);
                    renderCommits(commits);
                } else {
                    // 저장소가 초기화되지 않은 경우
                    renderCommits([]);
                }
            } catch (error) {
                console.error('커밋 히스토리 로드 실패:', error);
                renderCommits([]);
            }
        }

        // 프로젝트 상태 업데이트
        async function updateProjectStatus() {
            if (!currentProject) return;
            
            try {
                const result = await window.electron.dgit.status(currentProject.path);
                
                if (result.success) {
                    updateTerminalStatus(result.output);
                } else {
                    updateTerminalStatus('DGit 저장소가 초기화되지 않았습니다.');
                }
            } catch (error) {
                console.error('상태 업데이트 실패:', error);
                updateTerminalStatus('상태를 확인할 수 없습니다.');
            }
        }

        // 파일 목록 렌더링
        function renderFiles(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = files.map(file => `
                <div class="file-item" onclick="previewFile('${file.name}')">
                    <div class="file-thumbnail">${getFileIcon(file.type)}</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-details">${file.size} • ${file.modified}</div>
                    </div>
                    <div class="file-status" style="background: ${getStatusColor(file.status)}"></div>
                </div>
            `).join('');
        }

        // 커밋 목록 렌더링
        function renderCommits(commits) {
            const commitList = document.getElementById('commitList');
            commitList.innerHTML = commits.map(commit => `
                <div class="commit-item" onclick="viewCommit('${commit.hash}')">
                    <div class="commit-avatar">${commit.author[0]}</div>
                    <div class="commit-details">
                        <div class="commit-message">${commit.message}</div>
                        <div class="commit-meta">
                            <span>${commit.date}</span>
                            <span>${commit.hash}</span>
                            <span>${commit.files}개 파일</span>
                        </div>
                    </div>
                    <div class="commit-thumbnail"></div>
                </div>
            `).join('');
        }

        // 파일 아이콘 가져오기
        function getFileIcon(type) {
            const icons = {
                'psd': '🎨',
                'ai': '🖌️',
                'sketch': '✏️',
                'figma': '🎯',
                'xd': '💜',
                'png': '🖼️',
                'jpg': '📸',
                'svg': '🎭'
            };
            return icons[type] || '📄';
        }

        // 파일 상태 색상 가져오기
        function getStatusColor(status) {
            const colors = {
                'modified': 'var(--accent-orange)',
                'staged': 'var(--accent-blue)', 
                'committed': 'var(--accent-green)',
                'added': 'var(--accent-green)',
                'deleted': 'var(--accent-red)',
                'untracked': 'var(--text-secondary)',
                'unknown': 'var(--text-secondary)'
            };
            return colors[status] || 'var(--text-secondary)';
        }

        // 앱 초기화
        async function initializeApp() {
            try {
                // 설정 로드
                await loadAppConfig();
                
                // 최근 프로젝트 로드
                await loadRecentProjects();
                
                console.log('앱 초기화 완료');
            } catch (error) {
                console.error('앱 초기화 실패:', error);
            }
        }

        // 앱 설정 로드
        async function loadAppConfig() {
            try {
                const result = await window.electron.config.load();
                if (result.success) {
                    const config = result.config;
                    if (config.theme && config.theme !== currentTheme) {
                        currentTheme = config.theme;
                        document.body.setAttribute('data-theme', currentTheme);
                        updateThemeUI();
                    }
                }
            } catch (error) {
                console.error('설정 로드 실패:', error);
            }
        }

        // 최근 프로젝트 로드
        async function loadRecentProjects() {
            try {
                const result = await window.electron.recentProjects.load();
                if (result.success) {
                    window.recentProjectsList = result.projects || [];
                }
            } catch (error) {
                console.error('최근 프로젝트 로드 실패:', error);
                window.recentProjectsList = [];
            }
        }

        // 파일 크기 포맷팅
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return '방금 전';
            if (diffMins < 60) return `${diffMins}분 전`;
            if (diffHours < 24) return `${diffHours}시간 전`;
            if (diffDays < 7) return `${diffDays}일 전`;
            
            return date.toLocaleDateString('ko-KR');
        }

        // 파일 상태 업데이트
        async function updateFileStatuses(files) {
            if (!currentProject) return;
            
            try {
                const result = await window.electron.dgit.status(currentProject.path);
                if (result.success) {
                    const statusMap = parseGitStatus(result.output);
                    
                    files.forEach(file => {
                        if (statusMap[file.name]) {
                            file.status = statusMap[file.name];
                        } else {
                            file.status = 'committed';
                        }
                    });
                }
            } catch (error) {
                console.error('파일 상태 업데이트 실패:', error);
            }
        }

        // Git 상태 출력 파싱
        function parseGitStatus(output) {
            const statusMap = {};
            const lines = output.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // DGit 상태 출력 형식 파싱
                const match = trimmed.match(/^([MAD?!])\s+(.+)$/);
                if (match) {
                    const [, statusCode, filename] = match;
                    const status = getGitStatusText(statusCode);
                    statusMap[filename] = status;
                }
            }
            
            return statusMap;
        }

        // Git 상태 코드를 텍스트로 변환
        function getGitStatusText(statusCode) {
            const statusMap = {
                'M': 'modified',
                'A': 'added', 
                'D': 'deleted',
                'R': 'renamed',
                'C': 'copied',
                'U': 'updated',
                '?': 'untracked',
                '!': 'ignored'
            };
            return statusMap[statusCode] || 'unknown';
        }

        // 커밋 로그 파싱
        function parseCommitLog(output) {
            const commits = [];
            if (!output || !output.trim()) return commits;
            
            const lines = output.split('\n');
            let currentCommit = null;
            
            for (const line of lines) {
                if (line.startsWith('commit ')) {
                    if (currentCommit) {
                        commits.push(currentCommit);
                    }
                    // DGit 형식: "commit 4ea7d8384946 (v2)"
                    const commitMatch = line.match(/commit\s+([a-f0-9]+)\s*\(([^)]+)\)/);
                    if (commitMatch) {
                        currentCommit = {
                            hash: commitMatch[1].substring(0, 7),
                            version: commitMatch[2],
                            message: '',
                            author: '',
                            date: '',
                            files: 0
                        };
                    }
                } else if (line.startsWith('Author: ') && currentCommit) {
                    currentCommit.author = line.substring(8).trim();
                } else if (line.startsWith('Date: ') && currentCommit) {
                    const dateStr = line.substring(6).trim();
                    currentCommit.date = formatCommitDate(dateStr);
                } else if (line.startsWith('    ') && currentCommit && !currentCommit.message) {
                    // 커밋 메시지는 4개 공백으로 들여쓰기됨
                    currentCommit.message = line.trim();
                } else if (line.startsWith('    Files: ') && currentCommit) {
                    const filesMatch = line.match(/Files:\s+(\d+)/);
                    if (filesMatch) {
                        currentCommit.files = parseInt(filesMatch[1]);
                    }
                }
            }
            
            if (currentCommit) {
                commits.push(currentCommit);
            }
            
            return commits;
        }

        // 커밋 날짜 포맷팅
        function formatCommitDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return formatDate(date);
            } catch (error) {
                return dateStr;
            }
        }

        // 터미널 상태 업데이트
        function updateTerminalStatus(statusOutput) {
            const terminalStatus = document.getElementById('terminalStatus');
            if (terminalStatus) {
                terminalStatus.innerHTML = `<pre style="margin: 0; font-family: inherit;">${statusOutput}</pre>`;
            }
        }

        // 테마 UI 업데이트
        function updateThemeUI() {
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (currentTheme === 'light') {
                if (themeIcon) themeIcon.textContent = '🌞';
                if (themeText) themeText.textContent = '다크 모드로 전환';
            } else {
                if (themeIcon) themeIcon.textContent = '🌙';
                if (themeText) themeText.textContent = '라이트 모드로 전환';
            }
        }

        // 테마 토글
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (currentTheme === 'light') {
                themeIcon.textContent = '🌞';
                if (themeText) themeText.textContent = '다크 모드로 전환';
            } else {
                themeIcon.textContent = '🌙';
                if (themeText) themeText.textContent = '라이트 모드로 전환';
            }
            
            showToast('테마가 변경되었습니다', 'success');
        }

        // 트래픽 라이트 버튼 함수들
        function closeApp() {
            if (window.electron) {
                window.electron.closeApp();
            } else {
                window.close();
            }
        }

        function minimizeApp() {
            if (window.electron) {
                window.electron.minimizeApp();
            }
        }

        function maximizeApp() {
            if (window.electron) {
                window.electron.maximizeApp();
            }
        }

        // 홈 화면 버튼 함수들
        async function selectNewProject() {
            try {
                // 먼저 DGit CLI 사용 가능 여부 확인
                const isDGitAvailable = await checkDGitAvailability();
                
                if (!isDGitAvailable) {
                    showModal('DGit CLI 없음', 'DGit CLI를 찾을 수 없습니다', `
                        <div style="padding: 20px; text-align: center;">
                            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                                DGit CLI가 설치되어 있지 않거나 경로를 찾을 수 없습니다.<br>
                                그래도 프로젝트를 열어서 파일을 확인할 수 있습니다.
                            </p>
                            <button class="btn btn-primary" onclick="selectProjectWithoutDGit()">
                                DGit 없이 프로젝트 열기
                            </button>
                        </div>
                    `);
                    return;
                }

                const result = await window.electron.selectFolder();
                
                if (result.success) {
                    const projectInfo = {
                        name: result.name,
                        path: result.path
                    };
                    
                    // DGit 저장소 초기화 확인
                    const isRepo = await checkIfRepository(result.path);
                    
                    if (!isRepo) {
                        showModal('DGit 저장소 초기화', '이 폴더는 DGit 저장소가 아닙니다', `
                            <div style="padding: 20px;">
                                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                                    선택한 폴더에 DGit 저장소를 초기화하시겠습니까?<br>
                                    또는 DGit 없이 파일만 확인할 수도 있습니다.
                                </p>
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                                    <strong>폴더:</strong> ${result.path}
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: center;">
                                    <button class="btn btn-primary" onclick="initializeRepository(${JSON.stringify(projectInfo).replace(/"/g, '&quot;')})">
                                        DGit 저장소 초기화
                                    </button>
                                    <button class="btn btn-secondary" onclick="openProjectWithoutDGit(${JSON.stringify(projectInfo).replace(/"/g, '&quot;')})">
                                        DGit 없이 열기
                                    </button>
                                </div>
                            </div>
                        `);
                    } else {
                        await openProject(projectInfo);
                    }
                } else {
                    showToast('폴더 선택이 취소되었습니다', 'warning');
                }
            } catch (error) {
                console.error('프로젝트 선택 실패:', error);
                showToast('프로젝트 선택 중 오류가 발생했습니다', 'error');
            }
        }

        // DGit 없이 프로젝트 선택
        async function selectProjectWithoutDGit() {
            closeModal();
            
            try {
                const result = await window.electron.selectFolder();
                
                if (result.success) {
                    const projectInfo = {
                        name: result.name,
                        path: result.path
                    };
                    
                    await openProjectWithoutDGit(projectInfo);
                } else {
                    showToast('폴더 선택이 취소되었습니다', 'warning');
                }
            } catch (error) {
                console.error('프로젝트 선택 실패:', error);
                showToast('프로젝트 선택 중 오류가 발생했습니다', 'error');
            }
        }

        // DGit 기능 없이 프로젝트 열기
        async function openProjectWithoutDGit(projectInfo) {
            closeModal();
            
            currentProject = projectInfo;
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('workspace').classList.add('active');
            document.getElementById('titleText').textContent = `DGit MAC - ${projectInfo.name} (DGit 없음)`;
            document.getElementById('projectName').textContent = projectInfo.name;
            document.getElementById('projectPath').textContent = projectInfo.path;
            
            // 최근 프로젝트에 저장
            try {
                await window.electron.recentProjects.save(projectInfo);
                await loadRecentProjects();
            } catch (error) {
                console.error('최근 프로젝트 저장 실패:', error);
            }
            
            // 파일만 로드 (DGit 기능 제외)
            await loadProjectFilesOnly();
            
            showToast(`프로젝트 '${projectInfo.name}'을 열었습니다 (DGit 기능 없음)`, 'warning');
        }

        // 파일만 로드 (DGit 기능 제외)
        async function loadProjectFilesOnly() {
            if (!currentProject) return;
            
            try {
                const result = await window.electron.scanDirectory(currentProject.path);
                
                if (result.success) {
                    const files = result.files.map(file => ({
                        name: file.name,
                        type: file.type,
                        size: formatFileSize(file.size),
                        modified: formatDate(file.modified),
                        status: 'unknown',
                        path: file.path
                    }));
                    
                    renderFiles(files);
                    
                    // 빈 커밋 히스토리와 상태 표시
                    renderCommits([]);
                    updateTerminalStatus('DGit CLI를 사용할 수 없습니다. 파일 보기만 가능합니다.');
                } else {
                    showToast('파일을 스캔할 수 없습니다', 'error');
                }
            } catch (error) {
                console.error('파일 로드 실패:', error);
                showToast('파일 로드 중 오류가 발생했습니다', 'error');
            }
        }

        async function openCurrentProject() {
            // 최근 프로젝트 목록에서 가장 최근 프로젝트 가져오기
            const recentProjects = window.recentProjectsList || [];
            
            if (recentProjects.length > 0) {
                const mostRecentProject = recentProjects[0];
                await openProject(mostRecentProject);
            } else {
                showToast('진행 중인 프로젝트가 없습니다', 'warning');
            }
        }

        async function showRecentProjects() {
            const recentProjects = window.recentProjectsList || [];
            
            if (recentProjects.length === 0) {
                showModal('지난 프로젝트', '최근 작업한 프로젝트가 없습니다', `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>아직 작업한 프로젝트가 없습니다.</p>
                        <p>새 프로젝트를 선택하여 시작해보세요.</p>
                    </div>
                `);
                return;
            }

            const projectList = recentProjects.map(project => `
                <div class="file-item" onclick="openRecentProject('${project.path}', '${project.name}')">
                    <div class="file-thumbnail">📁</div>
                    <div class="file-info">
                        <div class="file-name">${project.name}</div>
                        <div class="file-details">${project.path} • ${formatDate(project.lastOpened)}</div>
                    </div>
                </div>
            `).join('');

            showModal('지난 프로젝트', '최근 작업한 프로젝트를 선택하세요', `
                <div class="file-list">
                    ${projectList}
                </div>
            `);
        }

        // 저장소 확인
        async function checkIfRepository(projectPath) {
            try {
                const result = await window.electron.dgit.status(projectPath);
                return result.success;
            } catch (error) {
                console.log('Repository check error:', error);
                return false;
            }
        }

        // DGit CLI 사용 가능 여부 확인
        async function checkDGitAvailability() {
            try {
                const result = await window.electron.dgit.command('help');
                return result.success;
            } catch (error) {
                return false;
            }
        }

        // 저장소 초기화
        async function initializeRepository(projectInfo) {
            closeModal();
            
            try {
                showToast('DGit 저장소를 초기화하는 중...', 'success');
                
                const result = await window.electron.dgit.init(projectInfo.path);
                
                if (result.success) {
                    showToast('DGit 저장소가 초기화되었습니다', 'success');
                    await openProject(projectInfo);
                } else {
                    showToast('저장소 초기화에 실패했습니다', 'error');
                }
            } catch (error) {
                console.error('저장소 초기화 실패:', error);
                showToast('저장소 초기화 중 오류가 발생했습니다', 'error');
            }
        }

        // 프로젝트 열기
        async function openProject(projectInfo) {
            currentProject = projectInfo;
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('workspace').classList.add('active');
            document.getElementById('titleText').textContent = `DGit MAC - ${projectInfo.name}`;
            document.getElementById('projectName').textContent = projectInfo.name;
            document.getElementById('projectPath').textContent = projectInfo.path;
            
            // 최근 프로젝트에 저장
            try {
                await window.electron.recentProjects.save(projectInfo);
                await loadRecentProjects(); // 목록 새로고침
            } catch (error) {
                console.error('최근 프로젝트 저장 실패:', error);
            }
            
            // 프로젝트 데이터 로드
            await loadProjectData();
            
            showToast(`프로젝트 '${projectInfo.name}'을 열었습니다`, 'success');
        }

        function openRecentProject(path, name) {
            closeModal();
            openProject({ name, path });
        }

        // 홈으로 돌아가기
        function goHome() {
            document.getElementById('workspace').classList.remove('active');
            document.getElementById('homeScreen').style.display = 'flex';
            document.getElementById('titleText').textContent = 'DGit MAC';
            currentProject = null;
        }

        // 사이드바 콘텐츠 표시
        function showContent(contentType) {
            // 모든 콘텐츠 섹션 숨기기
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // 사이드바 활성화 상태 변경
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 선택된 콘텐츠 표시
            document.getElementById(`${contentType}Content`).classList.remove('hidden');
            event.target.classList.add('active');
            activeContent = contentType;
        }

        // 터미널 탭 전환
        function showTerminalTab(tabType) {
            document.querySelectorAll('.terminal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            if (tabType === 'log') {
                document.getElementById('terminalLog').classList.remove('hidden');
                document.getElementById('terminalStatus').classList.add('hidden');
            } else {
                document.getElementById('terminalLog').classList.add('hidden');
                document.getElementById('terminalStatus').classList.remove('hidden');
            }
        }

        // 파일 미리보기
        function previewFile(filename) {
            showModal('파일 미리보기', filename, `
                <div style="text-align: center; padding: 40px;">
                    <div style="width: 200px; height: 150px; background: var(--bg-tertiary); border-radius: 8px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 3rem;">
                        ${getFileIcon(filename.split('.').pop())}
                    </div>
                    <p style="color: var(--text-secondary);">
                        ${filename}의 미리보기입니다.<br>
                        실제 구현에서는 이미지 썸네일이 표시됩니다.
                    </p>
                </div>
            `);
        }

        // 커밋 상세보기
        async function viewCommit(hash) {
            if (!currentProject) return;
            
            try {
                // 실제 커밋 정보 가져오기
                const result = await window.electron.dgit.command('show', ['--name-only', hash], currentProject.path);
                
                let commitDetails = `
                    <div style="padding: 20px;">
                        <h4 style="margin-bottom: 16px;">커밋 해시: ${hash}</h4>
                `;
                
                if (result.success) {
                    const lines = result.output.split('\n');
                    const commitMessage = lines.find(line => line.trim() && !line.startsWith('commit') && !line.startsWith('Author') && !line.startsWith('Date')) || '커밋 메시지 없음';
                    
                    commitDetails += `
                        <h4 style="margin: 20px 0 16px 0;">커밋 메시지:</h4>
                        <p style="color: var(--text-secondary); background: var(--bg-tertiary); padding: 12px; border-radius: 6px;">
                            ${commitMessage}
                        </p>
                    `;
                } else {
                    commitDetails += `
                        <p style="color: var(--text-secondary);">커밋 정보를 불러올 수 없습니다.</p>
                    `;
                }
                
                commitDetails += `</div>`;
                
                showModal('커밋 상세정보', `커밋 ${hash}`, commitDetails);
            } catch (error) {
                console.error('커밋 정보 로드 실패:', error);
                showModal('커밋 상세정보', `커밋 ${hash}`, `
                    <div style="padding: 20px;">
                        <p style="color: var(--text-secondary);">커밋 정보를 불러오는 중 오류가 발생했습니다.</p>
                    </div>
                `);
            }
        }

        // 프로젝트 변경
        async function changeProject() {
            await selectNewProject();
        }

        // 프로젝트 스캔
        async function scanProject() {
            if (!currentProject) {
                showToast('프로젝트가 선택되지 않았습니다', 'warning');
                return;
            }

            try {
                showToast('프로젝트를 스캔하고 있습니다...', 'info');
                await loadProjectData();
                showToast('프로젝트 스캔이 완료되었습니다', 'success');
            } catch (error) {
                console.error('프로젝트 스캔 실패:', error);
                showToast('프로젝트 스캔 중 오류가 발생했습니다', 'error');
            }
        }

        // 모든 파일 추가
        async function addAllFiles() {
            if (!currentProject) {
                showToast('프로젝트가 선택되지 않았습니다', 'warning');
                return;
            }

            try {
                const result = await window.electron.dgit.command('add', ['.'], currentProject.path);
                
                if (result.success) {
                    showToast('모든 파일이 스테이징 영역에 추가되었습니다', 'success');
                    await loadProjectData(); // 파일 상태 새로고침
                } else {
                    showToast('파일 추가 중 오류가 발생했습니다', 'error');
                }
            } catch (error) {
                console.error('파일 추가 실패:', error);
                showToast('파일 추가 중 오류가 발생했습니다', 'error');
            }
        }

        // 파일 복원
        async function restoreFiles() {
            if (!currentProject) {
                showToast('프로젝트가 선택되지 않았습니다', 'warning');
                return;
            }

            showModal('파일 복원', '변경사항을 복원하시겠습니까?', `
                <div style="padding: 20px;">
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        이 작업은 모든 변경사항을 마지막 커밋 상태로 되돌립니다.<br>
                        <strong style="color: var(--accent-red);">주의: 이 작업은 되돌릴 수 없습니다.</strong>
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                        <button class="btn btn-danger" onclick="performRestore()">복원 실행</button>
                    </div>
                </div>
            `);
        }

        // 복원 실행
        async function performRestore() {
            closeModal();
            
            try {
                const result = await window.electron.dgit.command('restore', ['.'], currentProject.path);
                
                if (result.success) {
                    showToast('파일이 복원되었습니다', 'success');
                    await loadProjectData(); // 파일 상태 새로고침
                } else {
                    showToast('파일 복원 중 오류가 발생했습니다', 'error');
                }
            } catch (error) {
                console.error('파일 복원 실패:', error);
                showToast('파일 복원 중 오류가 발생했습니다', 'error');
            }
        }

        // Finder에서 보기
        async function showInFinder() {
            if (!currentProject) {
                showToast('프로젝트가 선택되지 않았습니다', 'warning');
                return;
            }

            try {
                const result = await window.electron.showInFinder(currentProject.path);
                
                if (result.success) {
                    showToast('Finder에서 프로젝트 폴더를 열었습니다', 'success');
                } else {
                    showToast('Finder에서 열기 중 오류가 발생했습니다', 'error');
                }
            } catch (error) {
                console.error('Finder에서 보기 실패:', error);
                showToast('Finder에서 열기 중 오류가 발생했습니다', 'error');
            }
        }

        // 변경사항 커밋
        async function commitChanges() {
            if (!currentProject) {
                showToast('프로젝트가 선택되지 않았습니다', 'warning');
                return;
            }

            try {
                // 현재 상태 확인
                const statusResult = await window.electron.dgit.status(currentProject.path);
                let statusInfo = '상태를 확인할 수 없습니다';
                
                if (statusResult.success) {
                    const statusLines = statusResult.output.split('\n').filter(line => line.trim());
                    const modifiedCount = statusLines.filter(line => line.startsWith('M ')).length;
                    const addedCount = statusLines.filter(line => line.startsWith('A ')).length;
                    const deletedCount = statusLines.filter(line => line.startsWith('D ')).length;
                    const untrackedCount = statusLines.filter(line => line.startsWith('? ')).length;
                    
                    if (statusLines.length === 0) {
                        showToast('커밋할 변경사항이 없습니다', 'warning');
                        return;
                    }
                    
                    statusInfo = `변경된 파일: ${statusLines.length}개`;
                    if (modifiedCount > 0) statusInfo += ` • 수정: ${modifiedCount}개`;
                    if (addedCount > 0) statusInfo += ` • 추가: ${addedCount}개`;
                    if (deletedCount > 0) statusInfo += ` • 삭제: ${deletedCount}개`;
                    if (untrackedCount > 0) statusInfo += ` • 추적안됨: ${untrackedCount}개`;
                }

                showModal('변경사항 커밋', '커밋 메시지를 입력하세요', `
                    <div>
                        <textarea 
                            id="commitMessage" 
                            placeholder="커밋 메시지를 입력하세요..."
                            style="
                                width: 100%;
                                height: 100px;
                                background: var(--bg-secondary);
                                border: 1px solid var(--border-color);
                                border-radius: 6px;
                                padding: 12px;
                                color: var(--text-primary);
                                resize: vertical;
                                font-family: inherit;
                            "
                        ></textarea>
                        <div style="margin-top: 16px; color: var(--text-secondary); font-size: 0.9rem;">
                            ${statusInfo}
                        </div>
                    </div>
                `, () => {
                    const message = document.getElementById('commitMessage').value;
                    if (message.trim()) {
                        performCommit(message);
                    } else {
                        showToast('커밋 메시지를 입력해주세요', 'warning');
                    }
                });
            } catch (error) {
                console.error('커밋 준비 실패:', error);
                showToast('커밋 준비 중 오류가 발생했습니다', 'error');
            }
        }

        async function performCommit(message) {
            closeModal();
            
            if (!currentProject) {
                showToast('프로젝트가 선택되지 않았습니다', 'error');
                return;
            }

            try {
                showToast('변경사항을 커밋하는 중...', 'success');
                
                // 터미널에 로그 추가
                const terminalLog = document.getElementById('terminalLog');
                terminalLog.innerHTML += `
                    <div style="margin-bottom: 8px;">
                        <span style="color: var(--accent-blue);">⏳</span> 
                        <span style="color: var(--text-secondary);">[${new Date().toLocaleTimeString()}]</span>
                        커밋 시작: ${message}
                    </div>
                `;
                terminalLog.scrollTop = terminalLog.scrollHeight;

                const result = await window.electron.dgit.commit(currentProject.path, message);
                
                if (result.success) {
                    // 성공 로그 추가
                    terminalLog.innerHTML += `
                        <div style="margin-bottom: 8px;">
                            <span style="color: var(--accent-green);">✓</span> 
                            <span style="color: var(--text-secondary);">[${new Date().toLocaleTimeString()}]</span>
                            커밋 완료: ${message}
                        </div>
                    `;
                    terminalLog.scrollTop = terminalLog.scrollHeight;
                    
                    showToast('커밋이 완료되었습니다 ✅', 'success');
                    
                    // 프로젝트 데이터 새로고침
                    await loadProjectData();
                } else {
                    // 실패 로그 추가
                    terminalLog.innerHTML += `
                        <div style="margin-bottom: 8px;">
                            <span style="color: var(--accent-red);">✗</span> 
                            <span style="color: var(--text-secondary);">[${new Date().toLocaleTimeString()}]</span>
                            커밋 실패: ${result.error || '알 수 없는 오류'}
                        </div>
                    `;
                    terminalLog.scrollTop = terminalLog.scrollHeight;
                    
                    showToast(`커밋 실패: ${result.error || '알 수 없는 오류'}`, 'error');
                }
            } catch (error) {
                console.error('커밋 실행 실패:', error);
                
                // 에러 로그 추가
                const terminalLog = document.getElementById('terminalLog');
                terminalLog.innerHTML += `
                    <div style="margin-bottom: 8px;">
                        <span style="color: var(--accent-red);">✗</span> 
                        <span style="color: var(--text-secondary);">[${new Date().toLocaleTimeString()}]</span>
                        커밋 오류: ${error.message}
                    </div>
                `;
                terminalLog.scrollTop = terminalLog.scrollHeight;
                
                showToast('커밋 중 오류가 발생했습니다', 'error');
            }
        }

        // 브랜치 생성
        async function createBranch() {
            if (!currentProject) {
                showToast('프로젝트가 선택되지 않았습니다', 'warning');
                return;
            }

            try {
                // 현재 브랜치 확인
                const currentBranchResult = await window.electron.dgit.command('branch', ['--show-current'], currentProject.path);
                let currentBranch = 'main';
                
                if (currentBranchResult.success && currentBranchResult.output.trim()) {
                    currentBranch = currentBranchResult.output.trim();
                }

                showModal('새 브랜치 생성', '브랜치 이름을 입력하세요', `
                    <div>
                        <input 
                            type="text" 
                            id="branchName" 
                            placeholder="feature/new-design"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: var(--bg-secondary);
                                border: 1px solid var(--border-color);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-family: inherit;
                            "
                        />
                        <div style="margin-top: 16px; color: var(--text-secondary); font-size: 0.9rem;">
                            현재 브랜치: ${currentBranch}에서 분기됩니다
                        </div>
                    </div>
                `, () => {
                    const branchName = document.getElementById('branchName').value;
                    if (branchName.trim()) {
                        createNewBranch(branchName);
                    } else {
                        showToast('브랜치 이름을 입력해주세요', 'warning');
                    }
                });
            } catch (error) {
                console.error('브랜치 생성 준비 실패:', error);
                showToast('브랜치 생성 준비 중 오류가 발생했습니다', 'error');
            }
        }

        async function createNewBranch(name) {
            closeModal();
            
            if (!currentProject) {
                showToast('프로젝트가 선택되지 않았습니다', 'error');
                return;
            }

            try {
                showToast('브랜치를 생성하는 중...', 'success');
                
                const result = await window.electron.dgit.createBranch(currentProject.path, name);
                
                if (result.success) {
                    showToast(`브랜치 '${name}'가 생성되고 전환되었습니다`, 'success');
                    
                    // 터미널에 로그 추가
                    const terminalLog = document.getElementById('terminalLog');
                    terminalLog.innerHTML += `
                        <div style="margin-bottom: 8px;">
                            <span style="color: var(--accent-green);">✓</span> 
                            <span style="color: var(--text-secondary);">[${new Date().toLocaleTimeString()}]</span>
                            브랜치 '${name}' 생성 및 전환 완료
                        </div>
                    `;
                    terminalLog.scrollTop = terminalLog.scrollHeight;
                    
                    // 브랜치 그래프 업데이트 (간단한 시각화)
                    updateBranchGraph();
                } else {
                    showToast(`브랜치 생성 실패: ${result.error || '알 수 없는 오류'}`, 'error');
                }
            } catch (error) {
                console.error('브랜치 생성 실패:', error);
                showToast('브랜치 생성 중 오류가 발생했습니다', 'error');
            }
        }

        // 브랜치 그래프 업데이트
        async function updateBranchGraph() {
            if (!currentProject) return;
            
            try {
                const result = await window.electron.dgit.listBranches(currentProject.path);
                
                if (result.success) {
                    const branchGraph = document.getElementById('branchGraph');
                    branchGraph.innerHTML = ''; // 기존 내용 제거
                    
                    const branches = result.output.split('\n')
                        .map(line => line.trim())
                        .filter(line => line && !line.startsWith('*'))
                        .map(line => line.replace(/^\*\s*/, ''));
                    
                    branches.forEach((branch, index) => {
                        const newNode = document.createElement('div');
                        newNode.className = 'branch-node';
                        newNode.style.left = (index * 80 + 50) + 'px';
                        newNode.style.top = (Math.sin(index) * 30 + 100) + 'px';
                        newNode.title = branch;
                        branchGraph.appendChild(newNode);
                    });
                }
            } catch (error) {
                console.error('브랜치 그래프 업데이트 실패:', error);
            }
        }

        // 모달 관련 함수들
        function showModal(title, subtitle, body, confirmCallback = null) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalSubtitle').textContent = subtitle;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalOverlay').classList.add('show');
            
            // 확인 버튼 콜백 설정
            window.currentModalCallback = confirmCallback;
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            window.currentModalCallback = null;
        }

        function confirmModal() {
            if (window.currentModalCallback) {
                window.currentModalCallback();
            } else {
                closeModal();
            }
        }

        // 토스트 알림
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️';
            toast.innerHTML = `
                <span>${icon}</span>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                toast.style.animation = 'toastSlideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            if (e.metaKey || e.ctrlKey) {
                switch(e.key) {
                    case 'o':
                        e.preventDefault();
                        if (document.getElementById('homeScreen').style.display !== 'none') {
                            selectNewProject();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        if (currentProject) {
                            commitChanges();
                        }
                        break;
                    case 'w':
                        e.preventDefault();
                        goHome();
                        break;
                    case 'r':
                        e.preventDefault();
                        showToast('상태를 새로고침했습니다', 'success');
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                if (document.getElementById('modalOverlay').classList.contains('show')) {
                    closeModal();
                } else if (currentProject) {
                    goHome();
                }
            }
        });

        // 모달 오버레이 클릭시 닫기
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>